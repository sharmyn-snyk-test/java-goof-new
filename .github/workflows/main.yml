name: Snyk Security Scan with Summary

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  snyk_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Setup Java for the Maven project (This step remains the same)
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # 2. Install Snyk CLI on the runner
      - name: Install Snyk CLI
        uses: snyk/actions/setup@master

      # 3. Run Snyk Test (Open Source, Code, & Container) and save JSON
      #    We now run the Snyk CLI command directly on the runner.
      - name: Run Snyk Test and save JSON
        id: snyk_test
        # Set continue-on-error: true here to ensure the summary step runs even if issues are found
        continue-on-error: true
        run: snyk test --all-projects --json-file-output=snyk-results.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # 4. Process Snyk JSON and create Job Summary Table (This step remains the same)
      - name: Generate Security Summary Table
        run: |
          # Install jq for JSON processing
          sudo apt-get install jq -y
          
          # Read the JSON file content
          SNYK_JSON=$(cat snyk-results.json)
          
          # Use jq to extract and aggregate vulnerability counts by severity (for the first project result)
          HIGH_COUNT=$(echo "$SNYK_JSON" | jq -r '[.runs[] | select(.tool.driver.name == "snyk") | .results[].properties | .severity | select(. == "high")] | length')
          MEDIUM_COUNT=$(echo "$SNYK_JSON" | jq -r '[.runs[] | select(.tool.driver.name == "snyk") | .results[].properties | .severity | select(. == "medium")] | length')
          LOW_COUNT=$(echo "$SNYK_JSON" | jq -r '[.runs[] | select(.tool.driver.name == "snyk") | .results[].properties | .severity | select(. == "low")] | length')
          
          TOTAL_ISSUES=$((HIGH_COUNT + MEDIUM_COUNT + LOW_COUNT))
          
          # Determine the overall status emoji
          STATUS_EMOJI="✅"
          if [ "$TOTAL_ISSUES" -gt 0 ]; then
            STATUS_EMOJI="❌"
          fi
          
          # Construct the Markdown table and write to the job summary
          SUMMARY_MARKDOWN=$(cat <<-EOF
          
          ### Snyk Security Scan Summary ${STATUS_EMOJI}
          
          | Metric | Status | Count |
          | :--- | :---: | :---: |
          | **Total Issues Found** | ${STATUS_EMOJI} | **${TOTAL_ISSUES}** |
          | High Severity | ❌ | ${HIGH_COUNT} |
          | Medium Severity | ⚠️ | ${MEDIUM_COUNT} |
          | Low Severity | ⚪ | ${LOW_COUNT} |
          
          <br>
          
          > For full vulnerability details, please check the logs of the \`Run Snyk Test\` step or the **Security** tab (if SARIF is enabled).
          
          EOF
          )
          
          # Append the generated summary to the $GITHUB_STEP_SUMMARY file
          echo "$SUMMARY_MARKDOWN" >> $GITHUB_STEP_SUMMARY
