name: Snyk Security Scan with Summary

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  snyk_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Setup Java for the Maven project (Required to resolve inter-module dependencies)
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # 1.1 Add Maven Install Step (Crucial fix for your initial dependency errors)
      - name: Maven Build and Install
        run: mvn -B install -DskipTests
      
      # 2. Install Snyk CLI on the runner
      - name: Install Snyk CLI
        uses: snyk/actions/setup@master
        
      # 3. Run Snyk Test (Open Source, Code, & Container) and save JSON
      #    We use --json, not --json-file-output, as the setup action handles the output redirection.
      - name: Run Snyk Test and save JSON
        id: snyk_test
        # Set continue-on-error: true here to ensure the summary step runs even if issues are found
        continue-on-error: true
        run: snyk test --all-projects --json > snyk-results.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # 4. Process Snyk JSON and create Job Summary Table (CRITICAL FIX HERE)
      - name: Generate Security Summary Table
        run: |
          # Install jq for JSON processing
          # We check if it's already installed to avoid reinstalling if using snyk/actions/setup which might include it
          if ! command -v jq &> /dev/null; then
              sudo apt-get update && sudo apt-get install jq -y
          fi
          
          # Check if the Snyk output file exists and has content (handles empty runs)
          SNYK_FILE="snyk-results.json"
          if [ ! -s "$SNYK_FILE" ]; then
            echo "##
